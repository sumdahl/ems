@model EmployeeManagementSystem.Models.Employee
@{
    ViewData["Title"] = "Edit Employee";
}

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Edit Employee</h1>
    </div>

    <div class="bg-white shadow rounded-lg p-6">
        <form asp-action="Edit" method="post" novalidate>
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="CreatedAt" />
            <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-4"></div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label asp-for="FirstName" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="FirstName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="FirstName" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="LastName" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="LastName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="LastName" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="Email" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="Email" class="text-red-600 text-xs"></span>
                </div>

                <div>
                    <label asp-for="Gender" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <select asp-for="Gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                         <option value="0">Male</option>
                         <option value="1">Female</option>
                    </select>
                    <span asp-validation-for="Gender" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="Phone" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="Phone" id="phoneInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span id="phone-error" class="text-red-600 text-xs hidden">Invalid phone number</span>
                    <span asp-validation-for="Phone" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="HireDate" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="HireDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="HireDate" class="text-red-600 text-xs"></span>
                </div>
                

                
                <div>
                    <label asp-for="DepartmentId" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select asp-for="DepartmentId" id="departmentDropdown" asp-items="ViewBag.DepartmentId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
                    <span asp-validation-for="DepartmentId" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="RoleId" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select asp-for="RoleId" id="roleDropdown" asp-items="ViewBag.RoleId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
                    <span asp-validation-for="RoleId" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="Salary" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="Salary" type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="Salary" class="text-red-600 text-xs"></span>
                </div>


            </div>
            
            <div class="mt-6">
                <label asp-for="Address" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <textarea asp-for="Address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <span asp-validation-for="Address" class="text-red-600 text-xs"></span>
            </div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 mt-6">
                <div>
                    <label asp-for="AnnualLeaveBalance" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="AnnualLeaveBalance" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="AnnualLeaveBalance" class="text-red-600 text-xs"></span>
                </div>
                
                <div>
                    <label asp-for="SickLeaveBalance" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input asp-for="SickLeaveBalance" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <span asp-validation-for="SickLeaveBalance" class="text-red-600 text-xs"></span>
                </div>
            </div>

            <!-- Employment Status Section -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Employment Status</h3>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 items-center">
                    <div class="bg-gray-50 p-4 rounded-md">
                        <label asp-for="IsActive" class="flex items-center cursor-pointer">
                            <input asp-for="IsActive" type="checkbox" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                            <span class="ml-3 text-sm font-medium text-gray-900">Active Employee</span>
                        </label>
                        <p class="mt-1 text-xs text-gray-500 ml-8">Unchecking this may trigger offboarding logic.</p>
                    </div>

                    <div>
                        <label asp-for="TerminationDate" class="block text-sm font-medium text-gray-700 mb-1">Termination Date</label>
                        <input asp-for="TerminationDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <span asp-validation-for="TerminationDate" class="text-red-600 text-xs"></span>
                        <p class="mt-1 text-xs text-gray-500">Leave blank if currently employed.</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex items-center justify-between">
                <a asp-action="Index" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel</a>
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const departmentDropdown = document.getElementById('departmentDropdown');
            const roleDropdown = document.getElementById('roleDropdown');
            
            // Function to update roles
            function updateRoles(departmentId, selectedRoleId = null) {
                // Clear existing options but keep the default one temporarily or permanently?
                // We will rebuild the list.
                roleDropdown.innerHTML = '<option value="">-- Select Role --</option>';
                
                if (!departmentId) {
                    return; 
                }

                fetch(`/Departments/GetRolesByDepartment?departmentId=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id;
                            option.textContent = role.title;
                            // Re-select if it matches
                            if (selectedRoleId && role.id == selectedRoleId) {
                                option.selected = true;
                            }
                            roleDropdown.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching roles:', error));
            }

            // Event listener for department change
            departmentDropdown.addEventListener('change', function () {
                updateRoles(this.value);
            });
            
            // Initial load handling
            if (departmentDropdown.value) {
                const currentRoleId = roleDropdown.value;
                updateRoles(departmentDropdown.value, currentRoleId);
            }
        });
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <style>
        .iti { width: 100%; }
        /* Fix for input height being messed up by iti */
        .iti__flag-container {
             z-index: 10;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var input = document.querySelector("#phoneInput");
            var errorMsg = document.querySelector("#phone-error");
            var form = input.closest("form");

            // Initialise plugin
            var iti = window.intlTelInput(input, {
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
                separateDialCode: true,
                preferredCountries: ["np", "in", "us", "gb"], 
                initialCountry: "np",
                autoPlaceholder: "aggressive",
                formatOnDisplay: true,
            });

            // Restrict input to numeric + special formatting chars (allow space, dash, parenthesis, plus)
            input.addEventListener('input', function(e) {
                var value = this.value;
                var newValue = value.replace(/[^\d\s\-\(\)\+]/g, ''); 
                if (value !== newValue) {
                    this.value = newValue;
                }
            });

            var reset = function() {
                input.classList.remove("border-red-500");
                errorMsg.classList.add("hidden");
                errorMsg.innerHTML = "";
            };

            // Validate on blur
            input.addEventListener('blur', function() {
                reset();
                if (input.value.trim()) {
                    if (iti.isValidNumber()) {
                        // Valid
                    } else {
                        input.classList.add("border-red-500");
                        errorMsg.innerHTML = "Invalid phone number";
                        errorMsg.classList.remove("hidden");
                    }
                }
            });

            // Validate on submit
            form.addEventListener('submit', function(e) {
                reset();
                if (!input.value.trim()) {
                    return;
                }

                if (!iti.isValidNumber()) {
                    e.preventDefault();
                    input.classList.add("border-red-500");
                    errorMsg.innerHTML = "Please enter a valid phone number.";
                    errorMsg.classList.remove("hidden");
                    input.focus();
                    return false;
                }

                var fullNumber = iti.getNumber();
                input.value = fullNumber;
            });
            
            input.addEventListener('change', reset);
            input.addEventListener('keyup', reset);
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
